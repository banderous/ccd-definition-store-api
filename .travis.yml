language: java
jdk:
  - oraclejdk8

env:
  global:
    # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
    # via the "travis encrypt" command using the project repo's public key
    # encypted for db/$project
    - secure: "i1mJND7+boNc2QP4F/ZbKEYACpmMPmBFryaSp3qPARdljEDIwmlq4DaXVWx4AxXU0T2+Tvjw8KB3/snSBrlYXxrqEdCqmbTsYgzs8RuypZHg4r8R1qJgmz60Jyq6Npe4lK2f2o70ApF/yIIG5lSUgvKR5qyBFiZKaVM0DOEQ0s+r4NHU8YhB6WPm2veWfmtA7Lc20CuD6aya9QYq1YKAT7t7bSMwOC85gG4lrcH+PuMKjcoocwWhvVJ5msrlgZBghSCP2Asc+PtvWg6AZ7WTZUCAUZp+bdHRUeyAnet3ardKJ6u/zo0fgtPGrTR1da0maxFxhuM6gnbLi64iFl0o3YU8v/Cz0Jkiz2UoZQ+FdUAWLCf+JHZy1nPh0oEOiGmol7vMB7pNc7Nv+/SS1MLJKkFvYVy5M6KCq50Yi4g/aSfKQli9dxPDTAAWe59sNd3nSy2VaDA2nV6ccoh8Z1tpjggTlInV8CvM1TXTVqY9RlXBpofQnq3U+g/UvKeq/Cct7spT4Sp9Tn2UGhgCGUjHaBIqb0M9cZIbG5m4oGbCiuZ0qOFaZXmdib6os1tfBrusml2BW5pm8pbc78dDPX0S9dYLqyVWTmVLq6ez9rcR9CnCd7c6hiCckuzpATZ0ei/NKf1hzvhjCD+KH69pfI+c+QpLj7lTlJECyCA1XXocEl8="
    - CODACY_PROJECT_TOKEN=e9c07f97fad84186826f873f384a6112

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

before_install:
  - echo -n | openssl s_client -connect scan.coverity.com:443 2>./openssl-connect.stderr | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-certificates.crt
  - if [[ ${TRAVIS_BRANCH} == 'coverity_scan' ]]; then git remote add upstream https://github.com/hmcts/$(echo ${TRAVIS_REPO_SLUG} | cut -d "/" -f2).git; git remote -v; fi
  - if [[ ${TRAVIS_BRANCH} == 'coverity_scan' ]]; then git fetch upstream master; fi
  - if [[ ${TRAVIS_BRANCH} == 'coverity_scan' ]]; then git log -1 --pretty=format:%H upstream/master; fi
  - if [[ ${TRAVIS_BRANCH} == 'coverity_scan' ]]; then git rebase upstream/master; fi

script:
  - if [[ ${COVERITY_SCAN_BRANCH} == 1 ]];
    then
        echo "Don't build on coverty_scan branch.";
        exit 0;
    fi
  - "./gradlew build"
  - "./gradlew codeCoverageReport || echo 'code coverage upload failed'"

after_success:
  - "bash <(curl -s https://codecov.io/bash) || echo 'Codecov failed to upload'"

addons:
  coverity_scan:
    project:
      name: "dwaynebailey/ccd-definition-store-api"
      description: "CCD Definition Store API"
    notification_email: Dwayne.Bailey@HMCTS.net
    build_command: ./gradlew build
    branch_pattern: coverity_scan
